<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="DH.css">
    <title>ƒêi·ªÅu khi·ªÉn IoT qua TCP/IP</title>
</head>
<body>
    <div class="connection-panel">
        <h3>Thi·∫øt l·∫≠p k·∫øt n·ªëi</h3>
        <div class="form-group">
            <label for="ipAddress">ƒê·ªãa ch·ªâ IP:</label>
            <input type="text" id="ipAddress" placeholder="192.168.1.100" value="192.168.1.100">
        </div>
        <div class="form-group">
            <label for="port">Port:</label>
            <input type="number" id="port" placeholder="80" value="80">
        </div>
        <div class="form-group">
            <label for="deviceId">ID Thi·∫øt b·ªã:</label>
            <input type="text" id="deviceId" placeholder="iot-device-001" value="iot-device-001">
        </div>
        <button id="connectBtn" class="btn-connect" onclick="toggleConnection()">K·∫øt n·ªëi</button>
    </div>

    <div class="control-panel">
        <button class="btn-on" onclick="sendCommand('ON')" id="btnOn">B·∫¨T</button>
        <button class="btn-off" onclick="sendCommand('OFF')" id="btnOff">T·∫ÆT</button>
    </div>

    <div>
        <h3>L·ªánh t√πy ch·ªânh:</h3>
        <input type="text" id="customCommand" placeholder="Nh·∫≠p l·ªánh (VD: LED_ON, PUMP_START, etc.)">
        <button onclick="sendCustomCommand()" class="btn-custom">G·ª≠i l·ªánh</button>
    </div>

    <div id="status" class="status disconnected">Ch∆∞a k·∫øt n·ªëi</div>

    <script>
        let isConnected = false;
        let currentEndpoint = '';
        
        // C·∫≠p nh·∫≠t endpoint d·ª±a tr√™n IP v√† Port
        function updateEndpoint() {
            const ip = document.getElementById('ipAddress').value.trim();
            const port = document.getElementById('port').value.trim();
            currentEndpoint = `http://${ip}:${port}/api/iot/command`;
            return currentEndpoint;
        }
        
        // L·∫•y th√¥ng tin thi·∫øt b·ªã
        function getDeviceId() {
            return document.getElementById('deviceId').value.trim();
        }
        
        // K·∫øt n·ªëi/ng·∫Øt k·∫øt n·ªëi
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }
        
        function connect() {
            updateEndpoint();
            const ip = document.getElementById('ipAddress').value.trim();
            const port = document.getElementById('port').value.trim();
            
            if (!ip || !port) {
                showStatus('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß IP v√† Port', 'error');
                return;
            }
            
            // Ki·ªÉm tra k·∫øt n·ªëi b·∫±ng ping
            checkConnection()
                .then(() => {
                    isConnected = true;
                    updateUI();
                    showStatus(`‚úÖ ƒê√£ k·∫øt n·ªëi t·ªõi ${ip}:${port}`, 'success');
                })
                .catch(error => {
                    showStatus(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi ${ip}:${port}`, 'error');
                    console.error('L·ªói k·∫øt n·ªëi:', error);
                });
        }
        
        function disconnect() {
            isConnected = false;
            updateUI();
            showStatus('üîå ƒê√£ ng·∫Øt k·∫øt n·ªëi', 'disconnected');
        }
        
        // Ki·ªÉm tra k·∫øt n·ªëi
        async function checkConnection() {
            const testEndpoint = updateEndpoint().replace('/api/iot/command', '');
            
            try {
                const response = await fetch(testEndpoint, {
                    method: 'GET',
                    mode: 'no-cors', // Cho ph√©p ki·ªÉm tra k·∫øt n·ªëi cross-origin
                    cache: 'no-cache'
                });
                return true;
            } catch (error) {
                // Th·ª≠ k·∫øt n·ªëi tr·ª±c ti·∫øp t·ªõi endpoint
                try {
                    const response = await fetch(updateEndpoint(), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            command: 'PING',
                            timestamp: new Date().toISOString(),
                            deviceId: getDeviceId()
                        })
                    });
                    return response.ok;
                } catch (e) {
                    throw new Error('Cannot connect to device');
                }
            }
        }
        
        // G·ª≠i l·ªánh t·ªõi thi·∫øt b·ªã
        async function sendCommand(command) {
            if (!isConnected) {
                showStatus('Vui l√≤ng k·∫øt n·ªëi tr∆∞·ªõc khi g·ª≠i l·ªánh', 'error');
                return;
            }
            
            showStatus(`üì§ ƒêang g·ª≠i l·ªánh: ${command}...`, 'loading');
            
            try {
                const response = await fetch(updateEndpoint(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        command: command,
                        timestamp: new Date().toISOString(),
                        deviceId: getDeviceId()
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus(`‚úÖ ƒê√£ g·ª≠i: ${command} | ${result.message || 'Th√†nh c√¥ng'}`, 'success');
                } else {
                    showStatus(`‚ùå L·ªói ${response.status}: ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                console.error('L·ªói:', error);
                // T·ª± ƒë·ªông ng·∫Øt k·∫øt n·ªëi n·∫øu c√≥ l·ªói
                disconnect();
            }
        }

        function sendCustomCommand() {
            const command = document.getElementById('customCommand').value.trim();
            if (command) {
                sendCommand(command);
                document.getElementById('customCommand').value = '';
            } else {
                showStatus('Vui l√≤ng nh·∫≠p l·ªánh', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 5 gi√¢y (tr·ª´ l·ªói)
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusDiv.textContent === message) {
                        statusDiv.textContent = isConnected ? 'ƒê√£ k·∫øt n·ªëi' : 'Ch∆∞a k·∫øt n·ªëi';
                        statusDiv.className = `status ${isConnected ? 'success' : 'disconnected'}`;
                    }
                }, 5000);
            }
        }
        
        function updateUI() {
            const connectBtn = document.getElementById('connectBtn');
            const btnOn = document.getElementById('btnOn');
            const btnOff = document.getElementById('btnOff');
            
            if (isConnected) {
                connectBtn.textContent = 'Ng·∫Øt k·∫øt n·ªëi';
                connectBtn.className = 'btn-disconnect';
                btnOn.disabled = false;
                btnOff.disabled = false;
            } else {
                connectBtn.textContent = 'K·∫øt n·ªëi';
                connectBtn.className = 'btn-connect';
                btnOn.disabled = true;
                btnOff.disabled = true;
            }
        }

        // Ph√≠m t·∫Øt
        document.addEventListener('keydown', (e) => {
            if (e.key === '1') sendCommand('ON');
            if (e.key === '0') sendCommand('OFF');
            if (e.key === 'c' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                toggleConnection();
            }
        });
        
        // Kh·ªüi t·∫°o UI
        updateUI();
    </script>
</body>
</html>